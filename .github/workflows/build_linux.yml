# Build Linux packages: AppImage, .deb, .rpm
# Bundles libmpv and libmimalloc so users don't need to install them.
name: Build Linux (AppImage, deb, rpm)

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.0"
          channel: stable
          cache: true

      - name: Install build and packaging deps
        run: |
          sudo apt-get -qq update
          sudo apt-get -qq install -y \
            clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libmpv-dev \
            libmimalloc-dev patchelf file
          # For .rpm (on Ubuntu we use alien or fpm; fpm needs ruby)
          sudo apt-get -qq install -y ruby ruby-dev build-essential
          gem install fpm --no-document

      - name: Get version
        id: version
        run: |
          V=$(grep '^version:' pubspec.yaml | sed 's/version: *//;s/+.*//;s/ *$//')
          echo "version=${V}" >> "$GITHUB_OUTPUT"
          echo "Version: $V"

      - name: Flutter pub get
        run: flutter pub get

      - name: Build Linux release
        run: flutter build linux --release

      - name: Prepare staging (usr/bin, usr/lib, usr/data)
        run: |
          BUNDLE="build/linux/x64/release/bundle"
          STAGING="staging"
          mkdir -p "$STAGING/usr/bin" "$STAGING/usr/lib" "$STAGING/usr/data"
          cp "$BUNDLE/echo" "$STAGING/usr/bin/echo"
          cp -a "$BUNDLE/lib/"* "$STAGING/usr/lib/" 2>/dev/null || true
          cp -a "$BUNDLE/data/"* "$STAGING/usr/data/"
          # Bundle libmpv and libmimalloc so users don't need to install them
          ARCH=$(dpkg --print-architecture)
          for lib in libmpv libmimalloc; do
            for f in /usr/lib/$ARCH/$lib.so* /usr/lib/$lib.so*; do
              [ -e "$f" ] && cp -P "$f" "$STAGING/usr/lib/" && break
            done
          done
          # RPATH: binary is in usr/bin, libs in usr/lib
          patchelf --set-rpath '$ORIGIN/../lib' "$STAGING/usr/bin/echo"
          chmod +x "$STAGING/usr/bin/echo"
          # Staging for .deb/.rpm: Flutter engine looks for lib/ and data/ in executable's directory
          PKG_STAGING="pkg_staging"
          mkdir -p "$PKG_STAGING/usr/bin/lib" "$PKG_STAGING/usr/bin/data" "$PKG_STAGING/usr/share/applications" "$PKG_STAGING/usr/share/icons/hicolor/256x256/apps"
          cp "$STAGING/usr/bin/echo" "$PKG_STAGING/usr/bin/echo-music"
          cp -a "$STAGING/usr/lib/"* "$PKG_STAGING/usr/bin/lib/"
          cp -a "$STAGING/usr/data/"* "$PKG_STAGING/usr/bin/data/"
          cp icons/Echo_nobg.png "$PKG_STAGING/usr/share/icons/hicolor/256x256/apps/echo.png"
          cp linux/packaging/echo-music.desktop "$PKG_STAGING/usr/share/applications/echo-music.desktop"
          patchelf --set-rpath '$ORIGIN/lib' "$PKG_STAGING/usr/bin/echo-music"
          chmod +x "$PKG_STAGING/usr/bin/echo-music"

      - name: Build AppImage
        run: |
          STAGING="staging"
          VERSION="${{ steps.version.outputs.version }}"
          APP="Echo"
          APPDIR="Echo.AppDir"
          mkdir -p "$APPDIR/usr" "$APPDIR/usr/share/icons/hicolor/256x256/apps"
          cp -a "$STAGING/usr/bin" "$APPDIR/usr/"
          cp icons/Echo_nobg.png "$APPDIR/usr/share/icons/hicolor/256x256/apps/echo.png"
          cp linux/packaging/echo.desktop "$APPDIR/echo.desktop"
          cp linux/packaging/AppRun "$APPDIR/AppRun"
          chmod +x "$APPDIR/AppRun"
          # Download appimagetool
          curl -sL -o appimagetool.AppImage \
            "https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x appimagetool.AppImage
          ARCH=x86_64 ./appimagetool.AppImage -n "$APPDIR" "Echo-${VERSION}-x86_64.AppImage"

      - name: Build .deb
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PKG="echo-music_${VERSION}_amd64"
          mkdir -p "$PKG/DEBIAN" "$PKG/usr/share/applications" "$PKG/usr/share/icons/hicolor/256x256/apps"
          cp -a pkg_staging/usr/bin "$PKG/usr/"
          cp icons/Echo_nobg.png "$PKG/usr/share/icons/hicolor/256x256/apps/echo.png"
          cp linux/packaging/echo-music.desktop "$PKG/usr/share/applications/echo-music.desktop"
          sed "s/VERSION/$VERSION/" linux/packaging/control.in > "$PKG/DEBIAN/control"
          dpkg-deb --root-owner-group --build "$PKG" "echo-music_${VERSION}_amd64.deb"

      - name: Build .rpm
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          fpm -s dir -t rpm -n echo-music -v "$VERSION" \
            --architecture x86_64 \
            --description "Echo Music Desktop - Music player" \
            --url "https://github.com/echo-music/echo" \
            --license "Proprietary" \
            -C pkg_staging \
            usr
          mv echo-music-${VERSION}-1.x86_64.rpm "echo-music_${VERSION}_x86_64.rpm"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            Echo-*.AppImage
            echo-music_*_amd64.deb
            echo-music_*_x86_64.rpm
